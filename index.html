
<!DOCTYPE html>
<html lang="en">
    <head>
        <title>EEG signal classification demo</title>
        <!--Automatically generated by pyclientsideml. https://github.com/pbizopoulos/pyclientsideml-->
        <meta charset="UTF-8">
        <link href="data:" rel="icon">
        <style>
            #divInputControl{
                    border-style: groove;
                    }

            #divInput{
                    border-style: groove;
                    }

            #divOutput{
                    border-style: groove;
                    }

            #divInput:hover{
                    border-style: solid;
                    }
            </style>
        <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
        <script src="https://d3js.org/d3.v7.min.js"></script>
    </head>
    <body>
        <div id="divInputControl" style="width:256px;height:256px;position:fixed;top:0px;left:0px;">
            <div>NOT FOR MEDICAL USE. Choose a EEG csv file (.txt,.csv) and classify epilepsy using a DNN.</div>
            <div>
                <a href=https://github.com/pbizopoulos/signal2image-modules-in-deep-neural-networks-for-eeg-classification>[url]</a>
            </div>
            <div>
                <input accept=".txt,.csv" onchange="signalLoadView();" type="file">
            </div>
            <div>
                <select id="selectModel" onchange="loadModel(predictView);" style="width:100%;">
                    <option  value="https://raw.githubusercontent.com/pbizopoulos/signal2image-modules-in-deep-neural-networks-for-eeg-classification-tfjs/master/alexnet-1D/model.json">alexnet-1D</option>
                    <option  value="https://raw.githubusercontent.com/pbizopoulos/signal2image-modules-in-deep-neural-networks-for-eeg-classification-tfjs/master/lenet-1D/model.json">lenet-1D</option>
                    <option  value="https://raw.githubusercontent.com/pbizopoulos/signal2image-modules-in-deep-neural-networks-for-eeg-classification-tfjs/master/resnet18-1D/model.json">resnet18-1D</option>
                    <option  value="https://raw.githubusercontent.com/pbizopoulos/signal2image-modules-in-deep-neural-networks-for-eeg-classification-tfjs/master/resnet34-1D/model.json">resnet34-1D</option>
                    <option  value="https://raw.githubusercontent.com/pbizopoulos/signal2image-modules-in-deep-neural-networks-for-eeg-classification-tfjs/master/resnet50-1D/model.json">resnet50-1D</option>
                </select>
            </div>
            <div id="divModelDownloadFraction">0%</div>
            <div style="position:absolute;bottom:0;">Made with 
                <a href="https://github.com/pbizopoulos/pyclientsideml">pyclientsideml</a>.
            </div>
        </div>
        <div id="divInput" style="width:256px;height:256px;position:fixed;top:0px;left:256px;">
        </div>
        <div id="divOutput" style="height:256px;width:256px;position:fixed;top:0px;left:512px;">
        </div>
        <script>
            const canvasWidth = 256;
            const canvasHeight = 256;
            const inputFilename = "https://raw.githubusercontent.com/pbizopoulos/signal2image-modules-in-deep-neural-networks-for-eeg-classification/master/example-signal-1.txt";

            function drawSignal(text) {
                    const array = text.match(/\d+(?:\.\d+)?/g).map(Number);
                    csvDataset = tf.tensor(array);
                    csvDatasetMax = csvDataset.max().arraySync();
                    csvDatasetMin = csvDataset.min().arraySync();
                    const x = d3.scaleLinear()
                    .domain([0, csvDataset.size])
                    .range([0, canvasWidth]);
                    const y = d3.scaleLinear()
                    .domain([csvDatasetMin, csvDatasetMax])
                    .range([canvasHeight, 0]);
                    line = d3.line()
                    .x((d,i) => x(i))
                    .y(d => y(d));
                    d3.select('#pathInput')
                    .attr('d', line(csvDataset.arraySync()));
                    }

            const classNames = ['Open', 'Closed', 'Healthy', 'Tumor', 'Epilepsy'];
            if (inputFilename) {
                    fetch(inputFilename)
                    .then(response => response.text())
                    .then((text) => {
                        drawSignal(text);
                        predictView();
                        })
                    }

            let csvDataset;
            let csvDatasetMax;
            let csvDatasetMin;
            const svgInput = d3.select('#divInput')
                    .append('svg')
                    .attr('viewBox', [0, 0, canvasWidth, canvasHeight]);
            svgInput.append('path')
                    .attr('id', 'pathInput')
                    .style('fill', 'none')
                    .style('stroke', 'blue');
            d3.select('#divInput')
                    .call(d3.drag()
                            .on('start', (event) => {
                                event.on('drag', () => {
                                    const buffer = tf.buffer(csvDataset.shape, csvDataset.dtype, csvDataset.dataSync());
                                    buffer.set(csvDatasetMin + csvDatasetMax*(canvasHeight - window.event.pageY)/canvasHeight, Math.round(csvDataset.size*(window.event.pageX - canvasWidth)/canvasWidth));
                                    tf.dispose(csvDataset);
                                    csvDataset = buffer.toTensor();
                                    d3.select('#pathInput')
                                    .attr('d', line(csvDataset.arraySync()));
                                    predictView();
                                    });
                                }));

            let line;
            const signalFileReader = new FileReader();
            signalFileReader.onload = () => {
                    drawSignal(signalFileReader.result);
                    predictView();
                    };

            function signalLoadView() {
                    const files = event.currentTarget.files;
                    if (files[0]) {
                        signalFileReader.readAsText(files[0]);
                        }
                    }

            async function predictView() {
                    if (csvDataset === undefined) {
                        return;
                        }
                    if (model === undefined) {
                        return;
                        }
                    csvDatasetTmp = csvDataset.expandDims(0).expandDims(2);
                    csvDatasetTmp = tf.image.resizeBilinear(csvDatasetTmp, [1, model.inputs[0].shape[2]]);
                    csvDatasetTmp = csvDatasetTmp.reshape([1, 1, model.inputs[0].shape[2]]);
                    const modelOutput = await model.executeAsync(csvDatasetTmp);
                    const classProbabilities = modelOutput.softmax().mul(100).arraySync();
                    document.getElementById('divOutput').innerHTML = '';
                    for (let i = 0; i < classProbabilities[0].length; i++) {
                        document.getElementById('divOutput').innerHTML += `<div>${classNames[i]}: ${(classProbabilities[0][i]).toFixed(2)}%</div>`;
                        }
                    }

            function disableUI(argument) {
                    const nodes = document.getElementById('divInputControl').getElementsByTagName('*');
                    for(let i = 0; i < nodes.length; i++){
                        nodes[i].disabled = argument;
                        }
                    }

            let model;
            async function loadModel(predictFunction) {
                    const loadModelFunction = tf.loadGraphModel;
                    model = await loadModelFunction(selectModel.value, {
                        onProgress: function (fraction) {
                            document.getElementById('divModelDownloadFraction').innerHTML = 'Downloading model, please wait ' + Math.round(100*fraction) + '%.';
                            if (fraction == 1) {
                                document.getElementById('divModelDownloadFraction').innerHTML = 'Model downloaded.';
                                }
                            disableUI(true);
                            }
                        });
                    predictFunction();
                    disableUI(false);
                    }
            loadModel(predictView);
        </script>
    </body>
</html>